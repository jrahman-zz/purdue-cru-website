<?php
/**
 *
 * Action dispatcher to handle actions sent to the admin page
 * 
 */
class CRU_Action_Dispatch {
    
    public function __construct() {
        $this->handlers = array();
    }

    /**
     *
     * Register the module with Wordpress
     *
     */
    public function register_module() {
        // Add dummy handler page and init hook
        add_action('admin_menu', array($this, 'cru_add_handle_action_page'));
        add_action('admin_init', array($this, 'handle_action');
    }

    /**
     *
     * Register an action handler to be run on a given action
     *
     */
    public function register_action($action_name, $action_handler) {

        // TODO Consider adding validation for callability
        $this->handlers[$action_name] = $action_handler;
    }

    public $handlers;


    /**
     *
     * Run action handlers registered by the modules
     *
     */
    public function handle_action() {

        // Check that the handle action page was requested
        if (isset($_GET['page']) && $_GET['page'] == "cru-handle-action") {
            $action = CRU_Utils::get_request_param('action');
            if ($action !== NULL && isset($handlers[$action]) {
                
                $action_result = array();
                if (is_callable($handlers[$action])) {
                    $action_result = call_user_func($handlers[$action]);
                }
                    
                // Build the URL based on the action result
                // Note that message is included ONLY if success is also sent
                $page = $action_result["page"];
                if (isset($action_result['success'])) {
                    $page .= "&success=" . urlencode($action_result['success']);
                    if (isset($action_result['message'])) {
                        $page .= "&message=" . urlencode($action_result['message']);
                    }
                }
                $new_location = admin_url($page);
                wp_safe_redirect($new_location);

                // Dispatch the action by name  
                switch ($action) {
                    
                    
                    case "cru_send_test_text":
                        $action_result = CRU_Messaging::cru_send_test_text();
                        $page = "admin.php?page=cru-contacts";
                        break;
                    case "cru_edit_contact":
                        $action_result = CRU_Contacts::cru_edit_contact();
                        $page = "admin.php?page=cru-contacts";
                        break;
                    case "cru_flush_facebook_cache":
                        $feed = get_option('cru-facebook-feed', '');

                        $transient_name = "cru-facebook-events-$feed";
                        delete_transient($transient_name);
                        $action_result = array('success' => 'TRUE', 'message' => 'Cleared the cache');
                        $page = "admin.php?page=cru-admin";
                        break;
                    default:
                        $page = "admin.php";
                        break;  
                 }

                
            } else {
                // Redirect back to the main admin if we were not given an action
                wp_safe_redirect(admin_url("/admin.php"));
            }
        }
    } // public function cru_handle_action()
}
?>
